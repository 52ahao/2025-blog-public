## 一、背景与目标

很多智能设备（如部分热水回水器、第三方插座等）**不支持米家**，无法直接被小爱同学、天猫精灵、小度音箱等统一控制。若希望「说一句话就控制所有设备」，通常要：

- 要么只买各平台生态内设备（成本高、选择少），  
- 要么用巴法云这类**开放物联网平台**做「语音 → 主题消息」的桥，再自建**桥接服务**把主题消息转成对设备厂商 API 的调用。

本文方案：

- **语音统一入口**：使用 [巴法云](https://cloud.bemfa.com/docs/src/) 对接小爱同学、天猫精灵、小度、Google Assistant、Amazon Alexa 等（见巴法云文档 [智能音箱](https://cloud.bemfa.com/docs/src/)）。
- **桥接服务**：本仓库的 Node 后端订阅巴法云 MQTT 主题，收到 `on`/`off` 等指令后，调用设备厂商接口（如 ismartlife 回水器 API）完成实际控制。
- **0 成本**：巴法云免费使用；桥接服务可部署在**家庭内网 / 树莓派**或**腾讯云轻量等免费额度**上；配合 **腾讯 Edge One** 做域名接入、HTTPS 与加速（可选），实现「0 成本 + 统一语音控制」。

---

## 二、整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│  用户说：「小爱同学，打开回水器」 / 「天猫精灵，关闭回水器」 / 小度 等      │
└─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  巴法云 (https://cloud.bemfa.com)                                        │
│  · 小爱同学 / 天猫精灵 / 小度 等已对接，语音指令转为 MQTT 主题消息         │
│  · 文档：https://cloud.bemfa.com/docs/src/                              │
└─────────────────────────────────────────────────────────────────────────┘
                                      │
                    MQTT 订阅主题，收到 on / off 等消息
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  本仓库：智能家居桥接后端 (Node + Express + MQTT)                         │
│  · 订阅巴法云主题，收到语音对应的 on/off                                  │
│  · 根据配置将指令转发到具体设备 API（如 ismartlife 回水器）               │
│  · 可部署在内网 / 轻量服务器；对外 API 可经 Edge One 暴露与加速            │
└─────────────────────────────────────────────────────────────────────────┘
                                      │
                    HTTP 调用设备厂商开放接口
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  设备厂商云（如 ismartlife 微信小程序后端）                               │
│  · 控制真实硬件：回水器、插座、灯等                                      │
└─────────────────────────────────────────────────────────────────────────┘
```

- **巴法云**：负责「语音 → 主题」的标准化，支持 [MQTT](https://cloud.bemfa.com/docs/src/mqtt.html)、[TCP](https://cloud.bemfa.com/docs/src/tcp.html)、[设备接口](https://cloud.bemfa.com/docs/src/api_device.html) 等。
- **本后端**：只做「主题消息 → 设备 API」的桥接，与具体设备品牌解耦，便于扩展更多非米家设备。

---

## 三、巴法云侧配置（语音入口）

1. **注册与创建主题**  
   在 [巴法云控制台](https://cloud.bemfa.com) 注册，创建 MQTT 类型主题（如 `g5EuEJBm9006`），记下**用户私钥 (uid)**。

2. **小爱同学 / 天猫精灵 / 小度 对接**  
   在控制台按巴法云文档将主题与音箱绑定（每个音箱品牌有对应配置页），例如：
   - [小爱同学](https://cloud.bemfa.com/docs/src/)
   - [天猫精灵](https://cloud.bemfa.com/docs/src/)（若已下线则看文档当前说明）
   - [小度音箱](https://cloud.bemfa.com/docs/src/)  
   配置完成后，对音箱说「打开 xxx」「关闭 xxx」会向该主题发送 `on` / `off` 等消息。

3. **MQTT 连接信息（供本后端使用）**  
   - 服务器：`bemfa.com`  
   - 端口：`9501`（明文） / `9503`（TLS）  
   - 客户端 ID：填巴法云 **uid**，用户名密码可留空。  
   详见：[MQTT 协议接入](https://cloud.bemfa.com/docs/src/mqtt.html)。

---

## 四、本仓库桥接服务说明

### 4.1 能力概览

- **订阅巴法云 MQTT 主题**：使用 uid 作为 clientId，订阅你在控制台创建的主题。
- **语音联动**：当指定主题收到 `on` / `off` 时，可转发到任意设备 API；本项目示例为 **ismartlife 回水器**（开关 `on1`）。
- **巴法云 HTTP 控制**：提供 `/api/devices/push` 等接口，向指定主题发消息，方便用 App / 小程序 / 第三方控制。
- **Token 持久化与定时刷新**：ismartlife 的 access_token / refresh_token 存 MongoDB，并定时刷新，避免过期导致控制失败。

### 4.2 环境变量要点

| 变量 | 说明 |
|------|------|
| `BEMFA_UID` | 巴法云用户私钥 |
| `BEMFA_TOPICS` | 要监听的 MQTT 主题，逗号分隔 |
| `BEMFA_TOPIC_RECIRCULATOR` | 用于回水器语音联动的主题（收到 on/off 即控回水器） |
| ismartlife 相关 | 回水器：access_token、refresh_token、uid、deviceId、wxAppId 等（可从微信小程序抓包获取） |
| MongoDB | 持久化 token；可选，不用则设 `DB_ENABLED=0` |

### 4.3 部署与「0 成本」

- **必须 7×24 长连 MQTT**：本服务需常驻进程、持续连接巴法云 MQTT，因此不能部署在「无状态、短时执行」的纯边缘函数里。
- **推荐部署方式**：  
  - **家庭内网**：树莓派 / 旧电脑 / 路由器跑 Node，0 额外费用。  
  - **云上 0 成本 / 低成本**：腾讯云轻量新用户、阿里云等免费试用机，或其它支持 Node 长连的托管。
- **腾讯 Edge One 可参与的方式**：  
  - 若你对「桥接服务」暴露 HTTP API（如 `/api/recirculator/on`、`/api/devices/push`），可将域名接入 Edge One，用边缘节点做 **HTTPS 终止、防 DDoS、缓存与加速**，实现 0 成本安全暴露。  
  - 实际跑 MQTT 的 Node 进程仍在内网或轻量服务器上，Edge One 只做流量入口与加速。

即：**0 成本 = 巴法云免费 + 本开源项目免费 + 内网/免费额度跑 Node；Edge One 可选，用于域名与 API 的 0 成本加速与安全。**

---

## 五、快速开始

```bash
# 克隆或进入项目
cd 智能家居
cp .env.example .env
# 编辑 .env：BEMFA_UID、BEMFA_TOPICS、BEMFA_TOPIC_RECIRCULATOR、ismartlife 与 MongoDB 等

npm install
npm run dev
```

- 启动后会自动连接巴法云 MQTT、订阅配置的主题；收到语音对应的 `on`/`off` 会控制回水器并写日志。
- 定时任务会按配置间隔刷新 ismartlife token，并写入 MongoDB。

---

## 六、参考链接

- **项目地址**：<https://github.com/52ahao/zhineng>
- 巴法云入门与协议：<https://cloud.bemfa.com/docs/src/>  
- 巴法云 MQTT：<https://cloud.bemfa.com/docs/src/mqtt.html>  
- 巴法云设备接口（HTTP 推送等）：<https://cloud.bemfa.com/docs/src/api_device.html>  
- 智能音箱对接（小爱 / 天猫 / 小度等）：巴法云文档 → 智能音箱  

---

## 七、小结

| 环节 | 作用 | 成本 |
|------|------|------|
| 巴法云 | 语音 → 主题消息，统一小爱/天猫/小度等 | 免费 |
| 本仓库桥接 | 主题消息 → 设备 API（如回水器） | 开源免费 |
| 运行环境 | 内网 / 轻量 / 免费额度跑 Node，长连 MQTT | 0 或极低 |
| 腾讯 Edge One | 可选：API 域名、HTTPS、加速与安全 | 免费额度可用 |

通过巴法云 + 本桥接服务，可以将**不支持米家的设备**纳入小爱、天猫、小度等统一语音控制，并在合理部署下做到** 0 成本**；配合 Edge One 可进一步做 API 的 0 成本暴露与加速。
