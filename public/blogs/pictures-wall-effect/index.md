# 本博客 /pictures 图片墙效果介绍

本站在 **图片** 页（`/pictures`）做了一面可拖拽、可放大的「照片墙」：图片围绕视区中心呈螺旋排布，每张图有轻微旋转与错落感，支持拖拽、点击放大和描述浮层。下面按「布局算法」和「交互与实现」两部分说明。

---

## 一、布局：黄金角螺旋 + 稳定位置 + 抖动

图片墙不用网格，而是用 **黄金角螺旋** 把每张图放在一条从中心向外扩散的曲线上，这样既不会完全重叠，又不会显得太规整。

### 1. 黄金角与半径

代码里用到的角度为：

```ts
const goldenAngle = Math.PI * (3 - Math.sqrt(5))
```

即约 2.39996 弧度（约 137.5°），和植物学里叶序、向日葵种子的「黄金角」一致。每张图按一个**稳定索引**（由图片 URL 的哈希得出）换算成：

- **半径**：`radius = t^0.8 * maxRadius`，其中 `t ∈ [0, 1]`，`maxRadius` 为视区短边一半再减 100。指数 0.8 让内圈更密、外圈更疏。
- **角度**：`angle = stableIndex * goldenAngle`，所以索引相邻的图在圆周上均匀散开。

这样同一批图片每次打开页面，**每张图在螺旋上的相对位置是固定的**。

### 2. 稳定位置（同一张图不乱跳）

若直接用数组下标，增删图片会导致后面所有图位移。因此用 **图片 URL 的哈希** 生成一个稳定索引，再据此算 `(radius, angle)`，并写入 `positionCacheRef`。同一 URL 永远得到同一个 `(x, y, rotation)`，删掉别的图也不会让剩下的图换位置。

### 3. 抖动与旋转

在螺旋坐标上再加一层「抖动」，避免看起来像严格数学曲线：

- **平移抖动**：用同一哈希生成 `jitterX`、`jitterY`，在 ±12px 范围内偏移。
- **旋转**：用哈希生成 `rotation ∈ [-30°, 30°]`，每张图有轻微倾斜。

抖动和旋转都由 URL 哈希推导，所以**同一张图每次的偏移、旋转也一致**，刷新页面不会乱跑。

### 4. 单张图的显示尺寸

每张图加载后读取 `naturalWidth` / `naturalHeight`，按比例算展示宽高：

- 基准宽度 200px，高度按宽高比算，但**宽高比限制在 2/3～3/2**，避免过扁或过竖的长条，保持墙面视觉统一。

---

## 二、交互与实现要点

### 1. 入场动画

所有图不是同时出现，而是按索引**错峰 200ms** 依次出现（`setTimeout(..., 200 * index)`），并配合 Motion 的 `initial`（scale 0.6、opacity 0）到 `animate`（scale 1、opacity 1），形成轻微的「一张张飞入」效果。

### 2. 拖拽与位置持久化

- 每张图用 **Motion 的 `drag`**，以 `document.body` 为 `dragConstraints`，可在整页范围内拖动。
- 拖拽结束时的偏移 `(x, y)` 按**图片 URL** 存进 `localStorage`（key：`picture-offset-${url}`），下次进入页面时 `loadSavedOffset(url)` 读出并应用到 `x/y`。
- 因此每张图既可以按螺旋布局「归位」，也可以被用户拖到习惯位置，且**刷新后仍保留**。

### 3. 点击放大（查看大图）

- **短按**（按下到抬起 < 150ms）视为点击，否则视为拖拽。
- 点击后进入「放大」状态：图居中、旋转归零、尺寸按视区与原图比例放大到尽量大（留 24px 边距），背景为**毛玻璃**（`backdrop-blur-xl`），z-index 提到最前。
- 若该图有**描述**，会在放大时显示一个浮层卡片（上传时间 + 描述文案），卡片背景色从站点配置的 `backgroundColors` 中按组索引循环取，可拖拽。
- 再次点击或（移动端）点击空白可关闭放大。

### 4. 层级与悬停

- 鼠标按下时，当前图的 `zIndex` 会提升到「当前最大 + 1」，所以**拖拽或点击的图会浮到最前**。
- 非编辑模式下，未放大时悬停有 **scale 1.05** 的放大效果，方便区分当前指向的图。

### 5. 编辑模式

- 右上角可进入「编辑」：上传新图、删除单张或整组、保存后通过 GitHub API 推送到仓库（见 `push-pictures`）。
- 编辑态下每张图右上角有删除按钮；拖拽仍可用，但悬停不再放大，避免误触。

---

## 三、技术栈与文件位置

- **布局与动效**：React + [Motion](https://motion.dev/)（原 Framer Motion），`drag`、`initial`/`animate`/`transition` 均由 Motion 完成。
- **中心与视区**：页面中心坐标和视区宽高来自全局 `useCenterStore()`，保证螺旋以**当前视区中心**为原点，适配不同屏幕。
- **组件**：`/pictures` 页面使用 `RandomLayout`，单张图由 `FloatingImage` 渲染；布局算法在 `random-layout.tsx` 的 `getStablePosition` 中。

---

## 四、小结

| 能力 | 实现要点 |
|------|----------|
| 排布 | 黄金角螺旋 + URL 哈希稳定索引 + 半径 t^0.8 + 抖动与旋转 |
| 稳定 | 同一 URL 始终同一位置/旋转；增删别的不影响已有图 |
| 拖拽 | Motion `drag`，偏移按 URL 存 localStorage |
| 放大 | 短按判定，居中 + 等比放大 + 毛玻璃 + 描述浮层 |
| 层级 | 按下时提高 zIndex；放大时固定最高层 |

整体上，图片墙是「螺旋排布 + 可拖拽 + 可放大 + 描述浮层」的组合，适合做相册、随手拍或项目截图展示；数据存在 `list.json`，通过本站的 GitHub 推送能力同步到仓库。
